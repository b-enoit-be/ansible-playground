- hosts: localhost
  gather_facts: false

  vars:
    distributions:
      - alpine
      - debian
      - ubuntu

    package_managers:
      alpine: apk add --no-cache
      debian: &apt |-
        apt-get -qq update \
        && apt-get -qq install --yes --no-install-recommends
      ubuntu: *apt

  tasks:
    - set_fact:
        nodes: >-
          {{
            dict(
            distributions
              | zip(query('env', *['nodes_'] | product(distributions) | map('join')))
              | selectattr(1)
            )
          }}

    - ansible.builtin.template:
        src: node.Dockerfile.j2
        dest: "templates/{{ item }}.Dockerfile"
      loop: "{{ nodes.keys() }}"

    - ansible.builtin.template:
        src: compose.yml.j2
        dest: "templates/compose.yml"

    - community.docker.docker_compose:
        project_name: ansible
        project_src: templates
